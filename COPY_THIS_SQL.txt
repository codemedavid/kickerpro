-- ============================================
-- RUN THIS SQL IN SUPABASE SQL EDITOR
-- ============================================
-- Copy all of this and paste into Supabase SQL Editor, then click "Run"

-- Add Facebook OAuth token storage to users table
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS facebook_access_token TEXT,
ADD COLUMN IF NOT EXISTS facebook_token_expires_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS facebook_token_updated_at TIMESTAMPTZ;

-- Add index for faster token lookups
CREATE INDEX IF NOT EXISTS idx_users_facebook_id ON users(facebook_id);

-- Update the facebook_pages table to include token expiry
ALTER TABLE facebook_pages
ADD COLUMN IF NOT EXISTS access_token_expires_at TIMESTAMPTZ;

-- Add index for active pages lookup
CREATE INDEX IF NOT EXISTS idx_facebook_pages_user_active ON facebook_pages(user_id, is_active);

-- Create a function to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Add trigger to users table
DROP TRIGGER IF EXISTS update_users_updated_at ON users;
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Add trigger to facebook_pages table
DROP TRIGGER IF EXISTS update_facebook_pages_updated_at ON facebook_pages;
CREATE TRIGGER update_facebook_pages_updated_at
    BEFORE UPDATE ON facebook_pages
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Add Row Level Security (RLS) policies
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE facebook_pages ENABLE ROW LEVEL SECURITY;

-- Users can only see and update their own data
CREATE POLICY "Users can view own data" ON users
    FOR SELECT USING (auth.uid()::text = id::text);

CREATE POLICY "Users can update own data" ON users
    FOR UPDATE USING (auth.uid()::text = id::text);

-- Users can only see and manage their own pages
CREATE POLICY "Users can view own pages" ON facebook_pages
    FOR SELECT USING (auth.uid()::text = user_id::text);

CREATE POLICY "Users can update own pages" ON facebook_pages
    FOR UPDATE USING (auth.uid()::text = user_id::text);

CREATE POLICY "Users can insert own pages" ON facebook_pages
    FOR INSERT WITH CHECK (auth.uid()::text = user_id::text);

CREATE POLICY "Users can delete own pages" ON facebook_pages
    FOR DELETE USING (auth.uid()::text = user_id::text);
